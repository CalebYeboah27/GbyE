)
plots <- imap(blups_list, ~ {
trait_col <- .y               # "MST", "TWT", ...
trait_df  <- .x %>% select(HybID, all_of(trait_col))
# join the trait values onto the yld selection (keeps exact same HybIDs and order)
df <- yld_plt_data %>%
left_join(trait_df, by = "HybID") %>%
# ensure factor levels match the yld ordering (so x-axis is identical across traits)
mutate(HybPed = factor(HybPed, levels = levels(yld_plt_data$HybPed)))
# optional message if some selected hybrids don't exist in the trait df
missing_n <- sum(is.na(df[[trait_col]]))
if (missing_n > 0) message(sprintf("%s: %d missing values for the selected hybrids", trait_col, missing_n))
# build plot using the joined column name (works because the column name is trait_col)
ggplot(df, aes(x = HybPed, y = .data[[trait_col]], fill = HybClass)) +
coord_flip() +
geom_col() +
scale_x_discrete(labels = function(lbls) {
lbls %>%
str_replace_all(" ", "\u00A0") %>%
str_replace_all("\\+", "+\n") %>%
str_wrap(width = 30)
}) +
theme_classic() +
scale_fill_brewer(palette = "RdPu", direction = -1) +
labs(title = trait_col, x = "Hybrids", y = "BLUPs", fill = "Hybrids") +
theme(
axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5, size = 12),
axis.text.y = element_text(size = 12),
axis.title.x = element_text(size = 18),
legend.position = "top",
legend.direction = "horizontal"
)
})
# print all plots in the viewer
walk(plots, print)
plots <- imap(blups_list, ~ {
trait_col <- .y               # "MST", "TWT", ...
trait_df  <- .x %>% select(HybID, all_of(trait_col))
# join the trait values onto the yld selection (keeps exact same HybIDs and order)
df <- yld_plt_data %>%
left_join(trait_df, by = "HybID") %>%
# ensure factor levels match the yld ordering (so x-axis is identical across traits)
mutate(HybPed = factor(HybPed, levels = levels(yld_plt_data$HybPed)))
# optional message if some selected hybrids don't exist in the trait df
missing_n <- sum(is.na(df[[trait_col]]))
if (missing_n > 0) message(sprintf("%s: %d missing values for the selected hybrids", trait_col, missing_n))
# build plot using the joined column name (works because the column name is trait_col)
ggplot(df, aes(x = HybPed, y = .data[[trait_col]], fill = HybClass)) +
coord_flip() +
geom_col() +
scale_x_discrete(labels = function(lbls) {
lbls %>%
str_replace_all(" ", "\u00A0") %>%
str_replace_all("\\+", "+\n") %>%
str_wrap(width = 30)
}) +
theme_classic() +
scale_fill_brewer(palette = "RdPu", direction = 1) +
labs(title = trait_col, x = "Hybrids", y = "BLUPs", fill = "Hybrids") +
theme(
axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5, size = 12),
axis.text.y = element_text(size = 12),
axis.title.x = element_text(size = 18),
legend.position = "top",
legend.direction = "horizontal"
)
})
# print all plots in the viewer
walk(plots, print)
# optionally save them
imap(plots, ~ ggsave(filename = paste0("top13_", .y, ".png"), plot = .x, width = 8, height = 6, dpi = 300))
# optionally save them
imap(plots, ~ ggsave(filename = paste0("top13_", .y, ".png"), plot = .x, dpi = 300))
heritability_df <- tibble(
Model = c("FT Genes", "Whole Genome"),
Heritability = c(0.36, 0.67)
)
Het_plot <- heritability_df |>
ggplot(aes(x = Model, y = Heritability, fill = Model)) +
geom_col(position = position_dodge(width = 0.8)) +
coord_flip() +
labs(x = NULL, y = "Heritability", fill = "Window Size") +
theme_minimal(base_size = 14) +
theme() +
scale_fill_brewer(palette = "Reds") +
geom_text(aes(label = round(Heritability, 2)), hjust = -0.3) +
theme(
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
# Keep only major grid lines in very light grey
panel.grid.major = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
# Center and bold the title
plot.title = element_text(face = "bold", hjust = 0.5),
# Ensure all text is in black
legend.position = "top"
)
Het_plot
heritability_df <- tibble(
Trait = c("Yield", "MST", "TWT", "PLTHT", "EARHT"),
Heritability = c(0.6, 0.57, 0.71, 0.00000058, 0.67)
)
heritability_df <- tibble(
Trait = c("Yield", "MST", "TWT", "PLTHT", "EARHT"),
Heritability = c(0.6, 0.57, 0.71, 0.00000058, 0.67)
)
Het_plot <- heritability_df |>
ggplot(aes(x = Trait, y = Heritability, fill = Trait)) +
geom_col(position = position_dodge(width = 0.8)) +
coord_flip() +
labs(x = NULL, y = "Heritability", fill = "Window Size") +
theme_minimal(base_size = 14) +
theme() +
scale_fill_brewer(palette = "Reds") +
geom_text(aes(label = round(Heritability, 2)), hjust = -0.3) +
theme(
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
# Keep only major grid lines in very light grey
panel.grid.major = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
# Center and bold the title
plot.title = element_text(face = "bold", hjust = 0.5),
# Ensure all text is in black
legend.position = "top"
)
Het_plot
Het_plot <- heritability_df |>
ggplot(aes(x = Trait, y = Heritability, fill = Trait)) +
geom_col(position = position_dodge(width = 0.8)) +
coord_flip() +
labs(x = NULL, y = "Repeatability", fill = "Trait") +
theme_minimal(base_size = 14) +
theme() +
scale_fill_brewer(palette = "Reds") +
geom_text(aes(label = round(Heritability, 2)), hjust = -0.3) +
theme(
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
# Keep only major grid lines in very light grey
panel.grid.major = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
# Center and bold the title
plot.title = element_text(face = "bold", hjust = 0.5),
# Ensure all text is in black
legend.position = "top"
)
Het_plot
Het_plot
heritability_df <- tibble(
Trait = c("Yield", "MST", "TWT",  "EARHT"),
Heritability = c(0.6, 0.57, 0.71, 0.67)
)
Het_plot <- heritability_df |>
ggplot(aes(x = Trait, y = Heritability, fill = Trait)) +
geom_col(position = position_dodge(width = 0.8)) +
coord_flip() +
labs(x = NULL, y = "Repeatability", fill = "Trait") +
theme_minimal(base_size = 14) +
theme() +
scale_fill_brewer(palette = "Reds") +
geom_text(aes(label = round(Heritability, 2)), hjust = -0.3) +
theme(
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
# Keep only major grid lines in very light grey
panel.grid.major = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
# Center and bold the title
plot.title = element_text(face = "bold", hjust = 0.5),
# Ensure all text is in black
legend.position = "top"
)
Het_plot
Het_plot <- heritability_df |>
ggplot(aes(x = Trait, y = Heritability, fill = Trait)) +
geom_col(position = position_dodge(width = 0.8)) +
coord_flip() +
labs(x = NULL, y = "Repeatability", fill = "Trait") +
theme_minimal(base_size = 14) +
theme() +
scale_fill_brewer(palette = "RdPu") +
geom_text(aes(label = round(Heritability, 2)), hjust = -0.3) +
theme(
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
# Keep only major grid lines in very light grey
panel.grid.major = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
# Center and bold the title
plot.title = element_text(face = "bold", hjust = 0.5),
# Ensure all text is in black
legend.position = "top"
)
Het_plot
group3 |>
select(RecID, ExpID, LocID, EnvID, HybPed, HybID, HybType, TesterID, YLD) |>
filter(!is.na(YLD)) |>
count()
group3 |>
select(RecID, ExpID, LocID, EnvID, HybPed, HybID, HybType, TesterID, YLD) |>
filter(!is.na(YLD)) |>
distinct() |>
count()
blups_yld |> distinct()
blups_yld |> distinct() |> count
blups_yld |> distinct() |> count()
blups_yld$HybID |> distinct() |> count()
blups_yld$HybID |> unique() |> count()
blups_yld$HybID |> unique()
group3$HybID |> unique()
model_summ_yld$varcomp
# Repeatability
R_yld <- var_g / (var_g + var_gxe + var_r)
R_yld
getwd()
save.image("~/Documents/Caleb/Courses/GenotypeByEnvironment/AGRo896-003GXEProject/GbyE.RData")
load("~/Documents/Caleb/Courses/GenotypeByEnvironment/AGRo896-003GXEProject/GbyE.RData")
load("GbyE.RData")
yld_plt_data$HybPed
yld_plt_data <- blups_yld %>%
mutate(
HybPed = group3$HybPed[match(HybID, group3$HybID)],
HybType = group3$HybType[match(HybID, group3$HybID)],
HybClass = ifelse(HybType == 1, "Experimental Hybrid", "Commercial Check")
) %>%
filter(!is.na(HybPed)) %>%
select(HybPed, HybClass, HybID, YLD) %>%
arrange(desc(YLD)) %>%
slice_head(n = 23) %>%
mutate(HybPed = fct_reorder(HybPed, YLD))
yld_plt_data$HybPed
yld_plt_data <- blups_yld %>%
mutate(
HybPed = group3$HybPed[match(HybID, group3$HybID)],
HybType = group3$HybType[match(HybID, group3$HybID)],
HybClass = ifelse(HybType == 1, "Experimental Hybrid", "Commercial Check")
) %>%
filter(!is.na(HybPed)) %>%
select(HybPed, HybClass, HybID, YLD) %>%
arrange(desc(YLD)) %>%
slice_head(n = 25) %>%
mutate(HybPed = fct_reorder(HybPed, YLD))
yld_plt_data$HybPed
yld_plt_data <- blups_yld %>%
mutate(
HybPed = group3$HybPed[match(HybID, group3$HybID)],
HybType = group3$HybType[match(HybID, group3$HybID)],
HybClass = ifelse(HybType == 1, "Experimental Hybrid", "Commercial Check")
) %>%
filter(!is.na(HybPed)) %>%
select(HybPed, HybClass, HybID, YLD) %>%
arrange(desc(YLD)) %>%
slice_head(n = 30) %>%
mutate(HybPed = fct_reorder(HybPed, YLD))
yld_plt_data$HybPed
yld_plt_data <- blups_yld %>%
mutate(
HybPed = group3$HybPed[match(HybID, group3$HybID)],
HybType = group3$HybType[match(HybID, group3$HybID)],
HybClass = ifelse(HybType == 1, "Experimental Hybrid", "Commercial Check")
) %>%
filter(!is.na(HybPed)) %>%
select(HybPed, HybClass, HybID, YLD) %>%
arrange(desc(YLD)) %>%
slice_head(n = 28) %>%
mutate(HybPed = fct_reorder(HybPed, YLD))
yld_plt_data$HybPed
yld_plt_data %>%  ggplot(aes(x = HybPed, y = YLD, fill = HybClass)) +
coord_flip() +
geom_col() +
scale_x_discrete(labels = function(lbls) {
lbls %>%
str_replace_all(" ", "\u00A0") %>%
str_replace_all("\\+", "+\n") %>%
str_wrap(width = 30)
}) +
theme_classic() +
scale_fill_brewer(palette = "RdPu", direction = 1) +
#scale_fill_brewer(palette = "Reds", direction = 1) +
labs(title = "Yield", x = "Hybrids", y = "BLUPs", fill = "Hybrids") +
theme(
axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5, size = 12),
axis.text.y = element_text(angle = 0, hjust = 1, vjust = 0.5, size = 12),
axis.title.x = element_text(size = 18),
legend.position = "top",
legend.direction = "horizontal"
)
group3$HybType[match(blups_yld$HybID, group3$HybID)]
# Model Summary
model_summ_pltht <- summary(model_pltht, coef = TRUE)
model_summ_pltht
model_summ_pltht$varcomp
# Variance components
model_summ_yld$varcomp
# Variance components
model_summ_yld$varcomp
# Variance components
model_summ_pltht$varcomp
# Variance components
model_summ_earht$varcomp
# Variance components
model_summ_twt$varcomp
# Variance components
model_summ_mst$varcomp
# Repeatability
R_yld <- var_g / (var_g + var_gxe + var_r)
R_yld
# Extracting variance components
var_g <- model_summ_earht$varcomp$component[1]
var_gxe <- model_summ_earht$varcomp$component[2]
var_r <- model_summ_earht$varcomp$component[3]
# Repeatability
R_earht <- var_g / (var_g + var_gxe + var_r)
R_earht
group3_yld$HybID <- as.factor(group3_yld$HybID)
group3_yld$EnvID <- as.factor(group3_yld$EnvID)
# Model specification
model_yld <- asreml(
fixed    =  YLD ~ EnvID,
random   = ~ HybID + HybID:EnvID,
residual = ~ units,
data     = group3_yld
)
# Model Summary
model_summ_yld <- summary(model_yld, coef = TRUE)
# Fixed effects
model_summ_yld$coef.fixed
# Random Effects
model_summ_yld$coef.random
# Variance components
model_summ_yld$varcomp
# Extracting variance components
var_g <- model_summ_yld$varcomp$component[1]
var_gxe <- model_summ_yld$varcomp$component[2]
var_r <- model_summ_yld$varcomp$component[3]
# Repeatability
R_yld <- var_g / (var_g + var_gxe + var_r)
R_yld
group3_mst$HybID <- as.factor(group3_mst$HybID)
group3_mst$EnvID <- as.factor(group3_mst$EnvID)
group3_mst$HybType <- as.factor(group3_mst$HybType)
# Model specification
model_mst <- asreml(
fixed    =  MST ~ EnvID,
random   = ~ HybID + HybID:EnvID,
residual = ~ units,
data     = group3_mst
)
# Model Summary
model_summ_mst <- summary(model_mst, coef = TRUE)
# Fixed effects
model_summ_mst$coef.fixed
# Random Effects
model_summ_mst$coef.random
# Variance components
model_summ_mst$varcomp
# Extracting variance components
var_g <- model_summ_mst$varcomp$component[1]
var_gxe <- model_summ_mst$varcomp$component[2]
var_r <- model_summ_mst$varcomp$component[3]
# Repeatability
R_mst <- var_g / (var_g + var_gxe + var_r)
R_mst
group3_twt$HybID <- as.factor(group3_twt$HybID)
group3_twt$EnvID <- as.factor(group3_twt$EnvID)
group3_twt$HybType <- as.factor(group3_twt$HybType)
# Model specification
model_twt <- asreml(
fixed    =  TWT ~ EnvID,
random   = ~ HybID + HybID:EnvID,
residual = ~ units,
data     = group3_twt
)
# Model Summary
model_summ_twt <- summary(model_twt, coef = TRUE)
# Fixed effects
model_summ_twt$coef.fixed
# Random Effects
model_summ_twt$coef.random
# Variance components
model_summ_twt$varcomp
# Extracting variance components
var_g <- model_summ_twt$varcomp$component[1]
var_gxe <- model_summ_twt$varcomp$component[2]
var_r <- model_summ_twt$varcomp$component[3]
# Repeatability
R_twt <- var_g / (var_g + var_gxe + var_r)
R_twt
group3_earht$HybID <- as.factor(group3_earht$HybID)
group3_earht$EnvID <- as.factor(group3_earht$EnvID)
group3_earht$HybType <- as.factor(group3_earht$HybType)
min(group3_earht$EARHT)
max(group3_earht$EARHT)
# Model specification
model_earht <- asreml(
fixed    =  EARHT ~ EnvID,
random   = ~ HybID + HybID:EnvID,
residual = ~ units,
data     = group3_earht
)
# Model Summary
model_summ_earht <- summary(model_earht, coef = TRUE)
# Fixed effects
model_summ_earht$coef.fixed
# Random Effects
model_summ_earht$coef.random
# Variance components
model_summ_earht$varcomp
# Extracting variance components
var_g <- model_summ_earht$varcomp$component[1]
var_gxe <- model_summ_earht$varcomp$component[2]
var_r <- model_summ_earht$varcomp$component[3]
# Repeatability
R_earht <- var_g / (var_g + var_gxe + var_r)
R_earht
group3_pltht$HybID <- as.factor(group3_pltht$HybID)
group3_pltht$EnvID <- as.factor(group3_pltht$EnvID)
group3_pltht$HybType <- as.factor(group3_pltht$HybType)
min(group3_pltht$PLTHT)
max(group3_pltht$PLTHT)
# Model specification
model_pltht <- asreml(
fixed    =  PLTHT ~ EnvID,
random   = ~ HybID + HybID:EnvID,
residual = ~ units,
data     = group3_pltht
)
# Model Summary
model_summ_pltht <- summary(model_pltht, coef = TRUE)
# Fixed effects
model_summ_pltht$coef.fixed
# Random Effects
model_summ_pltht$coef.random
# Variance components
model_summ_pltht$varcomp
# Extracting variance components
var_g <- model_summ_pltht$varcomp$component[1]
var_gxe <- model_summ_pltht$varcomp$component[2]
var_r <- model_summ_pltht$varcomp$component[3]
# Repeatability
R_pltht <- var_g / (var_g + var_gxe + var_r)
R_pltht
heritability_df <- tibble(
Trait = c("Yield", "MST", "TWT",  "EARHT"),
Heritability = c(0.56, 0.57, 0.71, 0.67)
)
Het_plot <- heritability_df |>
ggplot(aes(x = Trait, y = Heritability, fill = Trait)) +
geom_col(position = position_dodge(width = 0.8)) +
coord_flip() +
labs(x = NULL, y = "Repeatability", fill = "Trait") +
theme_minimal(base_size = 14) +
theme() +
scale_fill_brewer(palette = "RdPu") +
geom_text(aes(label = round(Heritability, 2)), hjust = -0.3) +
theme(
axis.text.x = element_text(size = 14),
axis.text.y = element_text(size = 14),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
# Keep only major grid lines in very light grey
panel.grid.major = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
# Center and bold the title
plot.title = element_text(face = "bold", hjust = 0.5),
# Ensure all text is in black
legend.position = "top"
)
Het_plot
# Extracting variance components
var_g <- model_summ_earht$varcomp$component[1]
var_gxe <- model_summ_earht$varcomp$component[2]
var_r <- model_summ_earht$varcomp$component[3]
# Repeatability
R_earht <- var_g / (var_g + var_gxe + var_r)
# Variance components
model_summ_earht$varcomp
var_g
var_g
var_gxe
var_r
?anova()
anova(model_yld)
?lmer
??lmer
install.packages("lme4")
library(lme4)
??lmer
lmer(YLD ~ EnvID + (1|HybID) + (1|HybID:EnvID))
lmer(YLD ~ EnvID + (1|HybID) + (1|HybID:EnvID), data = group3_yld)
anova(lmer(YLD ~ EnvID + (1|HybID) + (1|HybID:EnvID), data = group3_yld))
?lmer
R_yld
model_summ_yld$varcomp
R_yld
HybID
blups_yld
View(blups_yld)
View(blups_yld)
effect_sizes
model_summ_yld
